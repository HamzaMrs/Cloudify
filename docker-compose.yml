version: '3.8'

services:
  # ============================================
  # TIER 1 : FRONTEND CLOUDIFY (React + Nginx)
  # ============================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    container_name: cloudify-frontend
    depends_on:
      - api-gateway
    networks:
      - cloudify-network

  # ============================================
  # TIER 2 : API Gateway (Point d'entrée + Auth)
  # ============================================
  api-gateway:
    build: ./silly-as-a-service/api-gateway
    ports:
      - "3000:3000"
    container_name: api-gateway
    environment:
      - USER_SERVICE_URL=http://user-service:8080
      - SILLY_SERVICE_URL=http://silly-generator:5000
    depends_on:
      - user-service
      - silly-generator
    networks:
      - cloudify-network

  # ============================================
  # TIER 3 : SERVICES MÉTIER
  # ============================================
  
  # Service Métier - User Service (Go + Auth)
  user-service:
    build: ./silly-as-a-service/user-service
    container_name: user-service
    environment:
      - DB_HOST=database
      - DB_USER=root
      - DB_PASSWORD=example
      - DB_NAME=silly_db
    depends_on:
      - database
    networks:
      - cloudify-network

  # Service Métier - Silly Generator (Python + Logique absurde)
  silly-generator:
    build: ./silly-as-a-service/silly-generator
    container_name: silly-generator
    environment:
      - OPENWEATHER_API_KEY=votre_cle
    networks:
      - cloudify-network

  # ============================================
  # TIER 4 : BASE DE DONNÉES (MySQL)
  # ============================================
  database:
    build: ./silly-as-a-service/database-service
    container_name: silly-database
    volumes:
      - db_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: silly_db
    networks:
      - cloudify-network

# Réseau Docker pour la communication inter-conteneurs
networks:
  cloudify-network:
    driver: bridge

# Volume persistant pour la base de données
volumes:
  db_data:
